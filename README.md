## `aarc-rc-converter`: AARC 至轨交棋地图转换工具

(Momochai, 2025.10.5)

### 编译

直接用 CMake 编译即可。 

### 使用说明

该工具有两种使用方式。

一种是直接在命令行参数中指定输入文件、输出文件与配置文件：
```
./aarc-rc-converter <输入文件> <输出文件> [--config <配置文件>]
```
另一种是直接打开工具后再指定输入文件、输出文件与配置文件。
```
./aarc-rc-converter
```
其中，输入文件为 AARC 存档的 JSON 工程文件，输出文件指定了轨交棋地图文件的输出位置；配置文件为可选项，包含对转换行为的自定义设置。

### 配置文件

配置文件是一个 JSON 文件，包含转换期间可能用到的自定义设置。如果一些设置项没有在配置文件中包含，或者不指定配置文件，转换工具会采用默认设置。

#### 功能：分段处理

有些线路或跨线体系能够产生非常多（甚至无穷多）种符合 AARC 存档的运行交路（比如，有大量支线和跨线的体系，或带若干支线的环线）。此时转换器会自动启用分段处理功能（也可以通过配置文件对一些线路强制启用）。简单来说，分段处理就是用较短的小段“线路”覆盖原本的真实线路，使得二者从轨交棋游戏角度看，对充分小的随机数没有区别。

#### 可用选项

下表为配置文件中可设置的参数。

|设置项|用途|默认|
|---|---|---|
|`max_length`|交路的最大长度 (车站与参考点的总数；下同) 参数 (一般情况下该参数无需调整；如果生成的交路不完整，请调大这一数值)。|`128`|
|`merge_consecutive_duplicates`|如果同一交路的相邻两站是同一车站且该设置项为 `true`，合并之。|`true`|
|`link_modes`|对不同车站连线的处理；具体见样例。支持五种不同的连线：粗线 `ThickLine`，细线 `ThinLine`，虚线 (原色) `DottedLine1`，虚线 (覆盖) `DottedLine2`，车站团 `Group`；对每种连线有三种处理方式：合并 `Group`，(用一条线路) 连接 `Connect`，忽略 `None`.| 粗线：连接，细线：连接，虚线：忽略，车站团：合并
|`friend_lines`|可跨线运行的线路列表。(可以用输入文件中的线路编号或线路名称表示线路；下同。)|无|
|`merged_lines`|无视线路朝向地跨线运行的线路列表。|无|
|`max_rc_steps`|分段处理时需要支持的轨交棋游戏内随机数最大值。|`16`|
|`optimize_segmentation`|是否开启分段处理优化。若开启，转换工具将尝试尽可能减少导出轨交棋存档中录入的线路数量。|`false`|
|`optimize_iterations`|分段处理优化迭代次数。|`5`|
|`segmented_lines`|一个列表，包括强制启用分段处理的线路列表和对应的分段长度；具体见下文。如果不指定分段长度，转换工具会将之设为 `max_rc_steps` 的两倍（若不使用分段处理优化），或（若使用分段处理优化）自动选取一个使得导出轨交棋存档中录入线路数量较小的数值。|无|

`segmented_lines` 列表中的每项可以是以下几种形式： 
|形式|功能|
|---|---|
|线路名称或编号|只指定线路，不指定分段长度。|
|线路名称或编号的列表|只指定一些线路，不指定分段长度。若开启分段处理优化，该列表中的所有线路将采用相同的分段长度。|
|`{"line": <线路名称或编号>, "segment_length": <分段长度>}`|指定线路和分段长度。|
|`{"lines": <线路名称或编号的列表>, "segment_length": <分段长度>}`|同时指定多条线路的分段长度。|

即使不指定分段处理的线路，转换器也会自动分段处理交路过于复杂的线路。因此，多数情况下可以不指定 `segmented_lines`.

#### 配置文件例 1

正常使用中较为常见的配置文件样式。

```JSON
{
  "link_modes": {
    "DottedLine1": "Connect",
    "DottedLine2": "Connect"
  },
  "friend_lines": [
    ["1 号线", "9 号线"]
  ]
}
```

#### 配置文件例 2

只是为了展示配置文件的全部功能；一般没有必要设置得这么复杂。

```JSON
{
  "max_length": 200,
  "merge_consecutive_duplicates": false,
  "link_modes": {
    "ThickLine": "Group",
    "ThinLine": "Connect",
    "DottedLine1": "Connect",
    "DottedLine2": "None",
    "Group": "Group"
  },
  "friend_lines": [
    ["1 号线", "2 号线"],
    [147, 65]
  ],
  "merged_lines": [
    ["机场快线", 257]
  ],
  "max_rc_steps": 14,
  "optimize_segmentation": true,
  "optimize_iterations": 5,
  "segmented_lines": [
    53,
    {"line": 95, "segment_length": 20},
    "轻轨市区线",
    [315, "3 号线"],
    {"lines": ["机场快线", 257, "环线"], "segment_length": 37}
  ]
}
```

#### 小技巧

- 在 AARC 中给所有线路取名，这样在配置文件中可以直接用线路名称表示线路，使用更方便。
- `merged_lines` 和 `friend_lines` 的实质区别在于，`friend_lines` 跨线需要跨线前后方向偏转角为锐角，而 `merged_lines` 不需要。一般情况下使用 `friend_lines` 即可。
- `merge_consecutive_duplicates` 选项主要是为了处理在 AARC 中画图时同一车站团中的不同车站点均加入了某一条线路的情况。如果确实存在在同一站连续停两次的交路，可以将它设为 `false`，但需要额外留意上述情况。
